# BCC-003: Add Playwright Tests for Drag-and-Drop

## Priority
**HIGH** - Essential for validation

## Description
Create comprehensive Playwright tests to verify drag-and-drop functionality works correctly and cards don't disappear.

## Test Scenarios

### 1. Basic Drag Operations
```typescript
test('drag card within lane without disappearing', async ({ page }) => {
  await page.goto('/#/bushing');
  await expect(page.getByText('Bushing Toolbox')).toBeVisible();
  
  // Drag first card to last position
  const firstCard = page.locator("[data-dnd-card='header']");
  const lastCard = page.locator("[data-dnd-card='process']");
  
  await firstCard.dragTo(lastCard);
  
  // Verify card is still visible
  await expect(firstCard).toBeVisible();
  
  // Verify new order is correct
  await expect.poll(async () =>
    page.evaluate(() => 
      JSON.parse(localStorage.getItem('scd.bushing.layout.v3') ?? '{}')?.leftCardOrder
    )
  ).toEqual(['guidance', 'setup', 'geometry', 'profile', 'process', 'header']);
});
```

### 2. Cross-Lane Drag (if supported)
```typescript
test('drag card between lanes', async ({ page }) => {
  // Test dragging from left to right lane
});
```

### 3. Persistence Test
```typescript
test('dragged card order persists after reload', async ({ page }) => {
  await page.goto('/#/bushing');
  
  // Perform drag operation
  await page.locator("[data-dnd-card='header']")
    .dragTo(page.locator("[data-dnd-card='process']"));
  
  // Reload page
  await page.reload();
  await expect(page.getByText('Bushing Toolbox')).toBeVisible();
  
  // Verify order persisted
  const order = await page.evaluate(() => 
    JSON.parse(localStorage.getItem('scd.bushing.layout.v3') ?? '{}')?.leftCardOrder
  );
  expect(order[order.length - 1]).toBe('header');
});
```

### 4. Nested Diagnostics Drag
```typescript
test('nested diagnostics cards drag without parent movement', async ({ page }) => {
  await page.goto('/#/bushing');
  
  const edge = page.locator("[data-diag-card='edge']");
  const wall = page.locator("[data-diag-card='wall']");
  
  await edge.dragTo(wall);
  
  await expect(edge).toBeVisible();
  await expect(wall).toBeVisible();
  
  // Verify diagnostics parent didn't move
  const rightOrder = await page.evaluate(() =>
    JSON.parse(localStorage.getItem('scd.bushing.layout.v3') ?? '{}')?.rightCardOrder
  );
  expect(rightOrder).toEqual(['drafting', 'summary', 'diagnostics']);
});
```

### 5. Animation Completion Test
```typescript
test('card remains visible during and after FLIP animation', async ({ page }) => {
  await page.goto('/#/bushing');
  
  const card = page.locator("[data-dnd-card='header']");
  
  // Start drag
  await card.hover();
  await page.mouse.down();
  
  // Move to new position
  const target = page.locator("[data-dnd-card='process']");
  await target.hover();
  
  // Verify card is visible during drag
  await expect(card).toBeVisible();
  
  // Release
  await page.mouse.up();
  
  // Wait for animation
  await page.waitForTimeout(250);
  
  // Verify card is still visible
  await expect(card).toBeVisible();
});
```

## Implementation Steps
1. Create test file: `tests/bushing-drag-drop.spec.ts`
2. Implement each test scenario
3. Add helper functions for common drag operations
4. Run tests and fix any issues
5. Add to CI/CD pipeline

## Acceptance Criteria
- [ ] All test scenarios pass
- [ ] Tests are deterministic (no flakes)
- [ ] Tests run in CI/CD
- [ ] Coverage includes edge cases
- [ ] Tests document expected behavior

## Files to Create
- `tests/bushing-drag-drop.spec.ts`
- `tests/helpers/drag-drop-helpers.ts` (optional)

## Testing
Run tests with:
```bash
npm run verify:bushing-e2e-smoke
playwright test tests/bushing-drag-drop.spec.ts
```

## Estimated Time
2-3 hours

## Dependencies
- BCC-001 must be completed first
